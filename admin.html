<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>เข้าสู่ระบบ Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      background-color: #f5f5f5;
      padding: 2rem;
    }

    .container {
      max-width: 600px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4 text-center">เข้าสู่ระบบ Admin</h2>

    <!-- หน้า Login -->
    <form id="loginForm">
      <div class="mb-3">
        <label for="usernameInput" class="form-label">ชื่อผู้ใช้</label>
        <input
          type="text"
          id="usernameInput"
          class="form-control"
          required
          autocomplete="username"
        />
      </div>
      <div class="mb-3">
        <label for="passwordInput" class="form-label">รหัสผ่าน</label>
        <input
          type="password"
          id="passwordInput"
          class="form-control"
          required
          autocomplete="current-password"
        />
      </div>
      <button type="submit" class="btn btn-primary w-100">เข้าสู่ระบบ</button>
    </form>

    <!-- หน้า Admin Panel -->
    <div id="adminPanel" class="d-none">
      <h3 class="mb-3">สร้างแบบฟอร์มใหม่</h3>

      <form id="formBuilder">
        <div class="mb-3">
          <label for="formTitleInput" class="form-label">ชื่อแบบฟอร์ม</label>
          <input
            type="text"
            id="formTitleInput"
            class="form-control"
            required
            placeholder="ชื่อแบบฟอร์ม"
          />
        </div>

        <div id="questionsArea"></div>

        <button type="button" class="btn btn-secondary mb-3" id="addQuestionBtn">
          เพิ่มคำถาม
        </button>

        <button type="submit" class="btn btn-success">สร้างแบบฟอร์ม</button>
      </form>

      <div id="linkResult" class="mt-3"></div>

      <button class="btn btn-danger mt-4" id="logoutBtn">ออกจากระบบ</button>
    </div>
  </div>

  <script>
    let config = {};
    let loggedIn = false;

    async function loadConfig() {
      try {
        const res = await fetch("config.json");
        config = await res.json();
        if (!config.scriptURL) throw new Error("scriptURL ไม่ถูกกำหนดใน config.json");
      } catch (e) {
        Swal.fire("เกิดข้อผิดพลาด", "ไม่พบไฟล์ config.json หรือ config ผิดพลาด", "error");
        throw e;
      }
    }

    async function sha256(text) {
      const msgUint8 = new TextEncoder().encode(text);
      const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
    }

    // ฟังก์ชันเพิ่มคำถาม
    function addQuestion(q = { type: "text", question: "", options: [] }) {
      const area = document.getElementById("questionsArea");
      const count = area.children.length + 1;

      const div = document.createElement("div");
      div.className = "mb-3 border p-3 rounded";
      div.dataset.index = count - 1;

      div.innerHTML = `
        <label class="form-label">คำถามที่ ${count}</label>
        <input type="text" class="form-control mb-2 question-text" placeholder="ข้อความคำถาม" required value="${q.question}" />

        <select class="form-select mb-2 question-type" required>
          <option value="text" ${q.type === "text" ? "selected" : ""}>คำถามแบบอัตนัย (ข้อความ)</option>
          <option value="choice" ${q.type === "choice" ? "selected" : ""}>คำถามแบบปรนัย (ตัวเลือก)</option>
        </select>

        <div class="options-area mb-2" style="display: ${
          q.type === "choice" ? "block" : "none"
        };">
          <label>ตัวเลือก:</label>
          <div class="options-list"></div>
          <button type="button" class="btn btn-sm btn-outline-secondary mt-2 add-option-btn">เพิ่มตัวเลือก</button>
        </div>

        <button type="button" class="btn btn-sm btn-danger remove-question-btn mt-2">ลบคำถาม</button>
      `;

      area.appendChild(div);

      if (q.type === "choice" && Array.isArray(q.options)) {
        const optionsList = div.querySelector(".options-list");
        q.options.forEach((opt) => {
          addOption(optionsList, opt);
        });
      }

      div.querySelector(".question-type").addEventListener("change", (e) => {
        const val = e.target.value;
        const optionsArea = div.querySelector(".options-area");
        if (val === "choice") {
          optionsArea.style.display = "block";
          const optionsList = optionsArea.querySelector(".options-list");
          if (optionsList.children.length === 0) {
            addOption(optionsList, "");
            addOption(optionsList, "");
          }
        } else {
          optionsArea.style.display = "none";
        }
      });

      div.querySelector(".add-option-btn").addEventListener("click", (e) => {
        e.preventDefault();
        const optionsList = div.querySelector(".options-list");
        addOption(optionsList, "");
      });

      div.querySelector(".remove-question-btn").addEventListener("click", () => {
        div.remove();
        updateQuestionLabels();
      });
    }

    function addOption(container, value) {
      const div = document.createElement("div");
      div.className = "input-group mb-1";

      div.innerHTML = `
        <input type="text" class="form-control option-input" placeholder="ตัวเลือก" required value="${value}" />
        <button class="btn btn-outline-danger btn-sm remove-option-btn" type="button">ลบ</button>
      `;

      container.appendChild(div);

      div.querySelector(".remove-option-btn").addEventListener("click", () => {
        div.remove();
      });
    }

    function updateQuestionLabels() {
      const questions = document.querySelectorAll("#questionsArea > div");
      questions.forEach((div, i) => {
        div.dataset.index = i;
        div.querySelector("label.form-label").textContent = `คำถามที่ ${i + 1}`;
      });
    }

    async function login(username, password) {
      const passwordHash = await sha256(password);

      try {
        const res = await fetch(
          `${config.scriptURL}?action=checkLogin&username=${encodeURIComponent(
            username
          )}&passwordHash=${passwordHash}`
        );
        const data = await res.json();

        if (data.success) {
          loggedIn = true;
          Swal.fire("เข้าสู่ระบบสำเร็จ", "", "success");
          document.getElementById("loginForm").classList.add("d-none");
          document.getElementById("adminPanel").classList.remove("d-none");

          if (document.getElementById("questionsArea").children.length === 0) {
            addQuestion();
          }
        } else {
          Swal.fire("ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง", "", "error");
        }
      } catch {
        Swal.fire("เกิดข้อผิดพลาดในการเชื่อมต่อ", "", "error");
      }
    }

    // โหลด config.json แล้วผูก event
    loadConfig()
      .then(() => {
        document
          .getElementById("loginForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            if (loggedIn) return;

            const username = document
              .getElementById("usernameInput")
              .value.trim();
            const password = document
              .getElementById("passwordInput")
              .value.trim();

            if (!username || !password) {
              Swal.fire("กรุณากรอกชื่อผู้ใช้และรหัสผ่าน", "", "warning");
              return;
            }

            await login(username, password);
          });

        document
          .getElementById("formBuilder")
          .addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!loggedIn) {
              Swal.fire("กรุณาเข้าสู่ระบบก่อน", "", "warning");
              return;
            }

            const title = document
              .getElementById("formTitleInput")
              .value.trim();
            if (!title) {
              Swal.fire("กรุณากรอกชื่อแบบฟอร์ม", "", "warning");
              return;
            }

            const questionsDivs = document.querySelectorAll(
              "#questionsArea > div"
            );
            if (questionsDivs.length === 0) {
              Swal.fire("กรุณาเพิ่มคำถามอย่างน้อย 1 ข้อ", "", "warning");
              return;
            }

            const questions = [];
            for (const div of questionsDivs) {
              const qText = div.querySelector(".question-text").value.trim();
              if (!qText) {
                Swal.fire("กรุณากรอกข้อความคำถามให้ครบถ้วน", "", "warning");
                return;
              }
              const qType = div.querySelector(".question-type").value;

              let qObj = {
                type: qType,
                question: qText,
              };

              if (qType === "choice") {
                const optionInputs = div.querySelectorAll(".option-input");
                const opts = Array.from(optionInputs)
                  .map((input) => input.value.trim())
                  .filter((v) => v.length > 0);

                if (opts.length < 2) {
                  Swal.fire(
                    "คำถามแบบปรนัยต้องมีตัวเลือกอย่างน้อย 2 ตัว",
                    "",
                    "warning"
                  );
                  return;
                }
                qObj.options = opts;
              }

              questions.push(qObj);
            }

            try {
              const res = await fetch(config.scriptURL, {
                method: "POST",
                body: JSON.stringify({
                  action: "createForm",
                  title,
                  questions,
                }),
              });
              const result = await res.json();

              if (result.success) {
                document.getElementById("linkResult").innerHTML = `
                <div class="alert alert-success">
                  ลิงก์แบบฟอร์มของคุณคือ:<br />
                  <a href="index.html?form=${result.formID}" target="_blank" rel="noopener noreferrer">เปิดแบบฟอร์ม</a>
                </div>`;
                Swal.fire("สร้างแบบฟอร์มสำเร็จ", "", "success");
              } else {
                Swal.fire("ไม่สามารถสร้างแบบฟอร์มได้", "", "error");
              }
            } catch {
              Swal.fire("เกิดข้อผิดพลาดในการเชื่อมต่อ", "", "error");
            }
          });

        document
          .getElementById("addQuestionBtn")
          .addEventListener("click", () => addQuestion());

        document
          .getElementById("logoutBtn")
          .addEventListener("click", () => {
            loggedIn = false;
            document.getElementById("adminPanel").classList.add("d-none");
            document.getElementById("loginForm").classList.remove("d-none");
            document.getElementById("loginForm").reset();
            document.getElementById("formTitleInput").value = "";
            document.getElementById("questionsArea").innerHTML = "";
            document.getElementById("linkResult").innerHTML = "";
          });
      })
      .catch(() => {
        document.getElementById("loginForm").style.display = "none";
      });
  </script>
</body>
</html>
