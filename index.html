<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>กำลังโหลด...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & SweetAlert -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { background-color: #f5f5f5; padding: 2rem; }
    .container { max-width: 800px; }
    .logo { max-height: 80px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="text-center mb-4">
      <img id="logo" src="" alt="Logo" class="logo mb-2 d-none">
      <h2 id="siteTitle">แบบทดสอบ</h2>
    </div>

    <form id="quizForm" class="d-none">
      <div class="mb-3">
        <label class="form-label">ชื่อ - สกุล</label>
        <input type="text" class="form-control" name="name" required>
      </div>
      <div id="questionArea"></div>
      <button type="submit" class="btn btn-primary mt-3">ส่งคำตอบ</button>
    </form>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const formID = params.get("form");
    let config = {};
    let questions = [];
    let screenshots = [];

    async function sha256(text) {
      const msgUint8 = new TextEncoder().encode(text);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function loadConfig() {
      const res = await fetch("config.json");
      config = await res.json();

      document.title = config.siteName || "แบบทดสอบ";
      document.getElementById("siteTitle").textContent = config.siteName || "แบบทดสอบ";

      if (config.logo) {
        const logo = document.getElementById("logo");
        logo.src = config.logo;
        logo.classList.remove("d-none");
      }
    }

    async function loadForm() {
      if (!formID) {
        Swal.fire("ลิงก์ไม่ถูกต้อง", "กรุณาเปิดแบบฟอร์มผ่านลิงก์ที่ถูกต้อง", "error");
        return;
      }

      const res = await fetch(`${config.scriptURL}?action=getForm&form=${formID}`);
      const data = await res.json();
      if (!data.success) {
        Swal.fire("ไม่พบแบบฟอร์ม", data.message || "ลิงก์นี้อาจหมดอายุหรือถูกลบ", "error");
        return;
      }

      questions = data.questions;
      const area = document.getElementById("questionArea");
      questions.forEach((q, i) => {
        area.innerHTML += `
          <div class="mb-3">
            <label class="form-label">${i + 1}. ${q}</label>
            <input type="text" class="form-control" name="q${i}" required>
          </div>
        `;
      });

      document.getElementById("quizForm").classList.remove("d-none");
      Swal.fire("กรุณาแชร์หน้าจอ", "ระบบจะจับภาพหน้าจอเป็นระยะเพื่อตรวจสอบความโปร่งใส", "info");
      await startScreenCapture();
    }

    async function startScreenCapture() {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const video = document.createElement('video');
        video.srcObject = stream;
        video.play();

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        setInterval(() => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          screenshots.push(canvas.toDataURL("image/jpeg"));
        }, 10000);
      } catch (err) {
        Swal.fire("ไม่สามารถจับหน้าจอได้", "กรุณาอนุญาตให้แชร์หน้าจอ", "error");
      }
    }

    document.getElementById("quizForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const name = formData.get("name").trim();
      const answers = questions.map((_, i) => formData.get(`q${i}`).trim());

      if (!name || answers.some(ans => !ans)) {
        return Swal.fire("กรุณากรอกข้อมูลให้ครบ", "", "warning");
      }

      const nameHash = await sha256(name);
      const answerHashes = await Promise.all(answers.map(ans => sha256(ans)));
      const screenshotsHash = await Promise.all(
        screenshots.map(img => sha256(img.slice(0, 100)))
      );

      const payload = {
        action: "submitAnswer",
        formID,
        name: nameHash,
        answers: answerHashes,
        screenshots: screenshotsHash
      };

      const res = await fetch(config.scriptURL, {
        method: "POST",
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      if (result.success) {
        Swal.fire("ส่งคำตอบสำเร็จ", "ขอบคุณสำหรับการทำแบบฟอร์ม", "success");
        form.reset();
      } else {
        Swal.fire("ล้มเหลว", "ไม่สามารถส่งคำตอบได้", "error");
      }
    });

    // เริ่มโหลดทุกอย่าง
    loadConfig().then(loadForm);
  </script>
</body>
</html>
