<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>แบบทดสอบออนไลน์</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">

  <div class="container my-5">
    <div class="text-center mb-4">
      <h1 id="formTitle">กำลังโหลด...</h1>
    </div>

    <form id="quizForm" class="card p-4 shadow-sm" style="display: none;">
      <div id="questionsContainer"></div>
      <div class="mt-4 d-flex justify-content-between">
        <button type="button" id="startRecBtn" class="btn btn-danger">เริ่มทำแบบทดสอบ (แชร์หน้าจอ)</button>
        <button type="submit" class="btn btn-primary">ส่งคำตอบ</button>
      </div>
    </form>

    <div class="mt-4" id="recordingPreview" style="display: none;">
      <h5>วิดีโอหน้าจอของคุณ:</h5>
      <video id="recordedVideo" width="100%" controls></video>
    </div>
  </div>

  <script>
    let CONFIG = {};
    let mediaRecorder, recordedChunks = [];

    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    function xorEncrypt(str, key) {
      return btoa([...str].map((ch, i) =>
        String.fromCharCode(ch.charCodeAt(0) ^ key.charCodeAt(i % key.length))
      ).join(""));
    }

    async function loadConfig() {
      try {
        const res = await fetch("config.json");
        CONFIG = await res.json();

        const formID = getQueryParam("formID");
        if (!formID) {
          Swal.fire("ไม่พบรหัสฟอร์ม", "โปรดเปิดผ่านลิงก์ที่มี ?formID=", "error");
          return;
        }

        document.getElementById("startRecBtn").addEventListener("click", () => {
          startExamWithRecording(formID);
        });
      } catch (err) {
        Swal.fire("โหลด config ไม่สำเร็จ", err.message, "error");
      }
    }

    async function startExamWithRecording(formID) {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const surface = stream.getVideoTracks()[0].getSettings().displaySurface;

        if (surface !== "monitor") {
          stream.getTracks().forEach(track => track.stop());
          return Swal.fire("ต้องแชร์ทั้งหน้าจอ", "", "warning").then(() => startExamWithRecording(formID));
        }

        mediaRecorder = new MediaRecorder(stream, {
          mimeType: CONFIG.VIDEO.MIME_TYPE || "video/webm"
        });

        recordedChunks = [];

        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const url = URL.createObjectURL(blob);
          const video = document.getElementById("recordedVideo");
          video.src = url;
          video.controls = true;
          document.getElementById("recordingPreview").style.display = "block";
        };

        mediaRecorder.start();
        Swal.fire("เริ่มทำแบบทดสอบ", "ระบบกำลังบันทึกหน้าจอของคุณ", "info");

        await loadForm(formID);
        document.getElementById("quizForm").style.display = "block";
        document.getElementById("startRecBtn").style.display = "none";

        stream.getVideoTracks()[0].onended = () => {
          Swal.fire("หยุดแชร์หน้าจอ", "แบบทดสอบจะสิ้นสุดทันที", "error")
            .then(() => window.location.reload());
        };
      } catch (err) {
        Swal.fire("ไม่สามารถเริ่มบันทึกหน้าจอ", err.message, "error");
      }
    }

    async function loadForm(formID) {
      try {
        const res = await fetch(`${CONFIG.SCRIPT_URL}?action=getForm&formID=${formID}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        document.getElementById("formTitle").textContent = data.title;
        renderQuestions(data.questions);
      } catch (err) {
        Swal.fire("โหลดฟอร์มไม่สำเร็จ", err.message, "error");
      }
    }

    function renderQuestions(questions) {
      const container = document.getElementById("questionsContainer");
      container.innerHTML = "";
      questions.forEach((q, i) => {
        const qDiv = document.createElement("div");
        qDiv.className = "mb-3";

        if (q.type === "text") {
          qDiv.innerHTML = `
            <label class="form-label">${q.question}</label>
            <textarea class="form-control" name="q${i}" rows="2" required></textarea>
          `;
        } else if (q.type === "choice") {
          const options = q.options.map(opt =>
            `<div class="form-check">
              <input class="form-check-input" type="radio" name="q${i}" value="${opt}" required>
              <label class="form-check-label">${opt}</label>
            </div>`
          ).join("");
          qDiv.innerHTML = `<label class="form-label">${q.question}</label>${options}`;
        }

        container.appendChild(qDiv);
      });

      document.getElementById("quizForm").addEventListener("submit", handleSubmit);
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const answers = {};

      [...form.elements].forEach(el => {
        if (el.name && (el.type === "textarea" || el.checked)) {
          answers[el.name] = el.value;
        }
      });

      const username = prompt("กรุณาใส่ชื่อของคุณ:");
      if (!username) return;

      const encryptedAnswers = xorEncrypt(JSON.stringify(answers), CONFIG.SECRET_KEY);
      const encryptedUsername = xorEncrypt(username, CONFIG.SECRET_KEY);
      const formID = getQueryParam("formID");

      const res = await fetch(CONFIG.SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "submitAnswerEncrypted",
          formID: formID,
          usernameEncrypted: encryptedUsername,
          answersEncrypted: encryptedAnswers
        })
      });

      const result = await res.json();
      if (result.success) {
        Swal.fire("ส่งสำเร็จ", "ระบบได้รับคำตอบของคุณแล้ว", "success");
        form.reset();

        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        }
      } else {
        Swal.fire("เกิดข้อผิดพลาด", result.message || "ไม่สามารถส่งคำตอบได้", "error");
      }
    }

    loadConfig();
  </script>
</body>
</html>
