<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & SweetAlert -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { background-color: #f5f5f5; padding: 2rem; }
    .container { max-width: 800px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
    <form id="quizForm">
      <div class="mb-3">
        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" class="form-control" name="name" required>
      </div>
      <div id="questionArea"></div>
      <button type="submit" class="btn btn-success mt-3">üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    </form>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'; // ‚Üê ‡πÉ‡∏™‡πà Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const params = new URLSearchParams(window.location.search);
    const formID = params.get("form");
    let questions = [];

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Æ‡∏ä SHA-256
    async function sha256(text) {
      const msgUint8 = new TextEncoder().encode(text);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
    async function loadForm() {
      if (!formID) {
        Swal.fire("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ú‡πà‡∏≤‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "error");
        return;
      }
      const res = await fetch(`${scriptURL}?action=getForm&form=${formID}`);
      const data = await res.json();
      if (!data.success) {
        Swal.fire("‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", data.message, "error");
        return;
      }

      questions = data.questions;
      const area = document.getElementById("questionArea");
      questions.forEach((q, i) => {
        area.innerHTML += `
          <div class="mb-3">
            <label class="form-label">${i + 1}. ${q}</label>
            <input type="text" class="form-control" name="q${i}" required>
          </div>
        `;
      });

      Swal.fire("‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ä‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏Å‡∏á", "info");
      await startScreenCapture();
    }

    // ‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û
    let screenshots = [];
    async function startScreenCapture() {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const video = document.createElement('video');
        video.srcObject = stream;
        video.play();

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        setInterval(() => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          screenshots.push(canvas.toDataURL("image/jpeg"));
        }, 10000);
      } catch (err) {
        Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏î‡πâ", "error");
      }
    }

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
    document.getElementById("quizForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const name = formData.get("name");
      const answers = questions.map((_, i) => formData.get(`q${i}`));

      if (!name || answers.some(ans => !ans)) {
        return Swal.fire("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "", "warning");
      }

      // ‡πÅ‡∏Æ‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
      const nameHash = await sha256(name);
      const answerHashes = await Promise.all(answers.map(ans => sha256(ans)));
      const screenshotsHashed = await Promise.all(
        screenshots.map(s => sha256(s.slice(0, 100)))
      );

      const payload = {
        action: "submitAnswer",
        formID,
        name: nameHash,
        answers: answerHashes,
        screenshots: screenshotsHashed,
      };

      const res = await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(payload),
      });

      const result = await res.json();
      if (result.success) {
        Swal.fire("‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß", "success");
        form.reset();
      } else {
        Swal.fire("‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á", "error");
      }
    });

    loadForm();
  </script>
</body>
</html>
