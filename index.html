<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Language Quiz Game</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Google Fonts for multiple languages -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
    <!-- Chart.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --success-color: #00b894;
            --danger-color: #d63031;
            --warning-color: #fdcb6e;
            --info-color: #0984e3;
            --gold-color: #ffd700;
            --silver-color: #c0c0c0;
            --bronze-color: #cd7f32;
            --dark-color: #2d3436;
            --light-color: #f8f9fa;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #dfe6e9 100%);
        }
        
        body {
            font-family: 'Poppins', 'Noto Sans Thai', 'Noto Sans SC', 'Noto Sans JP', 'Noto Sans KR', sans-serif;
            background: var(--bg-gradient);
            color: var(--dark-color);
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            color: var(--dark-color);
        }
        
        .container {
            max-width: 1200px;
        }
        
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.95);
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), #5d4fe0);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
            padding: 15px 20px;
            font-size: 1.1rem;
        }
        
        .btn {
            border-radius: 12px;
            font-weight: 600;
            padding: 10px 24px;
            transition: all 0.3s ease;
            border: none;
            font-size: 1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #5d4fe0);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5649c0, #4d42b0);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #00a383);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c02727);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #f0b84c);
            color: var(--dark-color);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #0877c7);
        }
        
        .form-control, .form-select {
            border-radius: 12px;
            padding: 12px 18px;
            border: 2px solid #e0e0e0;
            font-size: 1rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(108, 92, 231, 0.25);
        }
        
        .help-button {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, var(--primary-color), #5d4fe0);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            cursor: pointer;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .help-button:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .player-details {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .player-details-content {
            background-color: white;
            border-radius: 20px;
            width: 90%;
            max-width: 550px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            animation: modalIn 0.4s ease;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .room-id {
            color: var(--primary-color);
            font-size: 1.3rem;
            letter-spacing: 1px;
            font-weight: 700;
            background: rgba(108, 92, 231, 0.1);
            padding: 8px 15px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .question-card {
            background-color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }
        
        .option-btn {
            width: 100%;
            margin-bottom: 15px;
            text-align: left;
            padding: 15px 25px;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-size: 1.05rem;
            border: 2px solid #e0e0e0;
            background: white;
        }
        
        .option-btn:hover {
            transform: translateX(8px);
            border-color: var(--primary-color);
        }
        
        .option-btn.correct {
            background: linear-gradient(135deg, var(--success-color), #00a383);
            color: white;
            border-color: var(--success-color);
        }
        
        .option-btn.incorrect {
            background: linear-gradient(135deg, var(--danger-color), #c02727);
            color: white;
            border-color: var(--danger-color);
        }
        
        .option-btn.selected {
            background: linear-gradient(135deg, var(--primary-color), #5d4fe0);
            color: white;
            border-color: var(--primary-color);
        }
        
        .timer-container {
            width: 100%;
            height: 12px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #5d4fe0);
            width: 100%;
            transition: width 1s linear;
            border-radius: 10px;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            margin-bottom: 12px;
            border-radius: 12px;
            background-color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        }
        
        .leaderboard-item.me {
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.12), rgba(108, 92, 231, 0.08));
            border-left: 5px solid var(--primary-color);
        }
        
        .leaderboard-position {
            font-weight: bold;
            width: 35px;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .leaderboard-name {
            flex-grow: 1;
            margin: 0 20px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 1.1rem;
        }
        
        .leaderboard-score {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
            min-width: 60px;
            text-align: right;
        }
        
        .medal-gold {
            color: var(--gold-color);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .medal-silver {
            color: var(--silver-color);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .medal-bronze {
            color: var(--bronze-color);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .fullscreen-leaderboard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            z-index: 1500;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .answer-chart-container {
            height: 320px;
            margin-bottom: 30px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        .history-chart-container {
            height: 280px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        /* Language Selector */
        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .language-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .language-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        
        .language-options {
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            padding: 10px 0;
            display: none;
            width: 180px;
            z-index: 1001;
        }
        
        .language-option {
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .language-option:hover {
            background: rgba(108, 92, 231, 0.1);
        }
        
        .language-option.active {
            background: rgba(108, 92, 231, 0.15);
            font-weight: 600;
        }
        
        .flag-icon {
            width: 24px;
            height: 18px;
            margin-right: 12px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        /* Home screen enhancements */
        .welcome-container {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(245,247,250,0.9));
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .welcome-title {
            font-size: 2.8rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary-color), #5d4fe0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }
        
        .welcome-subtitle {
            font-size: 1.4rem;
            color: #555;
            margin-bottom: 40px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .mode-card {
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.4s ease;
            height: 100%;
            border: none;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        
        .mode-card:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .mode-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary-color), #5d4fe0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Question animations */
        @keyframes fadeInQuestion {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .question-animate {
            animation: fadeInQuestion 0.6s ease;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .welcome-title {
                font-size: 2.2rem;
            }
            
            .welcome-subtitle {
                font-size: 1.1rem;
            }
            
            .card {
                margin-bottom: 20px;
            }
            
            .language-selector {
                top: 15px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Language Selector -->
    <div class="language-selector">
        <div class="language-btn" id="currentLanguage">EN</div>
        <div class="language-options" id="languageOptions">
            <div class="language-option active" data-lang="en">
                <img src="https://flagcdn.com/w40/gb.png" class="flag-icon"> English
            </div>
            <div class="language-option" data-lang="th">
                <img src="https://flagcdn.com/w40/th.png" class="flag-icon"> ไทย
            </div>
            <div class="language-option" data-lang="zh">
                <img src="https://flagcdn.com/w40/cn.png" class="flag-icon"> 中文
            </div>
            <div class="language-option" data-lang="ja">
                <img src="https://flagcdn.com/w40/jp.png" class="flag-icon"> 日本語
            </div>
            <div class="language-option" data-lang="ko">
                <img src="https://flagcdn.com/w40/kr.png" class="flag-icon"> 한국어
            </div>
        </div>
    </div>

    <div id="app" class="container mt-4 mb-5">
        <!-- เนื้อหาจะถูก render โดย JavaScript -->
    </div>
    
    <!-- ปุ่มช่วยเหลือ (สำหรับผู้เล่น) -->
    <div id="helpButton" class="help-button animate__animated animate__pulse" style="display: none;">
        <i class="fas fa-question"></i>
    </div>
    
    <!-- Player details modal -->
    <div id="playerDetails" class="player-details">
        <div class="player-details-content">
            <div class="player-details-header d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
                <h4 id="playerDetailsTitle" class="mb-0">Player Details</h4>
                <button class="btn btn-close" onclick="hidePlayerDetails()"></button>
            </div>
            <div id="playerDetailsContent">
                <!-- Content will be filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- PeerJS -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        // Application State
        const appState = {
            role: null,
            peer: null,
            connections: {},
            hostConnection: null,
            quizData: {
                questions: [],
                currentQuestion: 0,
                answers: {},
                timePerQuestion: 30,
                showAnswer: false
            },
            players: {},
            playerName: '',
            timer: null,
            timeLeft: 0,
            playerScore: 0,
            answerSubmitted: false,
            answerChart: null,
            historyChart: null,
            helpUsed: false,
            leaderboardHistory: [],
            remoteControl: {
                isControlled: false,
                controllerPeerId: null,
                controllerConnection: null,
                controlCode: null,
                connectionStatus: 'disconnected'
            },
            antiCheat: {
                answerTimeThreshold: 3000,
                readingTimePerCharacter: 250,
                optionChangeThreshold: 2,
                suspiciousPatterns: {},
                cheatingDetected: {}
            },
            lastLeaderboardUpdate: 0,
            leaderboardUpdateInterval: null,
            controlUpdateInterval: null,
            debugMode: false,
            tutorial: {
                currentStep: 1,
                totalSteps: 4
            },
            currentLanguage: 'en',
            translations: {
en: {
    welcomeTitle: "Multi-Language Quiz Game",
    welcomeSubtitle: "Challenge your knowledge with friends in multiple languages",
    hostMode: "Be a Host",
    playerMode: "Be a Player",
    remoteMode: "Mobile Control",
    enterName: "Enter your name",
    hostName: "Host Name",
    confirm: "Confirm",
    backHome: "Back to Home",
    joinGame: "Join Game",
    playerName: "Player Name",
    roomCode: "Room Code",
    join: "Join",
    questions: "Questions",
    addQuestion: "Add Question",
    timePerQuestion: "Time per question (seconds)",
    startGame: "Start Game",
    players: "Players",
    waitingForHost: "Waiting for host to start the game",
    question: "Question",
    timeLeft: "seconds left",
    leaderboard: "Leaderboard",
    playerDetails: "Player Details",
    score: "Score",
    finalResults: "Final Results",
    backMain: "Back to Main",
    restartGame: "Restart Game",
    copyCode: "Copy Code",
    tutorial: "Tutorial",
    remoteControl: "Remote Control",
    connected: "Connected",
    disconnected: "Disconnected",
    controlCode: "Control Code",
    connect: "Connect",
    startQuiz: "Start Quiz",
    nextQuestion: "Next Question",
    showAnswer: "Show Answer",
    endGame: "End Game",
    import: "Import",
    export: "Export",
    newQuestion: "Question",
    noQuestions: "No questions",
    noPlayers: "No players",
    option: "Option",
    success: "Success",
    codeCopied: "Code copied",
    playersAnswered: "Players Answered",
    correctAnswerIs: "Correct answer is...",
    error: "Error",
    noQuestionsToExport: "No questions to export",
    connecting: "Connecting",
    waitingForHostDesc: "Waiting for host...",
    pleaseWait: "Please wait...",
    correctAnswers: "Correct Answers",
    newPlayer: "New Player",
    answerHistory: "Answer History",
    playerAnswers: "Player Answers",
    connectionError: "Connection error: ",
    ok: "OK",
    importSuccess: "Import success"
},
                th: {
                    welcomeTitle: "เกมตอบคำถามหลายภาษา",
                    welcomeSubtitle: "ท้าทายความรู้กับเพื่อน ๆ ในหลายภาษา",
                    hostMode: "เป็นผู้จัดเกม",
                    playerMode: "เป็นผู้เล่น",
                    remoteMode: "ควบคุมผ่านมือถือ",
                    enterName: "กรุณากรอกชื่อของคุณ",
                    hostName: "ชื่อผู้จัดเกม",
                    confirm: "ยืนยัน",
                    backHome: "กลับหน้าหลัก",
                    joinGame: "เข้าร่วมเกม",
                    playerName: "ชื่อผู้เล่น",
                    roomCode: "รหัสห้อง",
                    join: "เข้าร่วม",
                    questions: "คำถาม",
                    addQuestion: "เพิ่มคำถาม",
                    timePerQuestion: "เวลาตอบคำถาม (วินาที)",
                    startGame: "เริ่มเกม",
                    players: "ผู้เล่น",
                    waitingForHost: "รอผู้จัดเกมเริ่มเกม",
                    question: "คำถาม",
                    timeLeft: "วินาทีเหลือ",
                    leaderboard: "อันดับผู้เล่น",
                    playerDetails: "รายละเอียดผู้เล่น",
                    score: "คะแนน",
                    finalResults: "ผลลัพธ์สุดท้าย",
                    backMain: "กลับหน้าหลัก",
                    restartGame: "เริ่มเกมใหม่",
                    copyCode: "คัดลอกรหัส",
                    tutorial: "คู่มือ",
                    remoteControl: "ควบคุมระยะไกล",
                    connected: "เชื่อมต่อแล้ว",
                    disconnected: "การเชื่อมต่อถูกตัด",
                    controlCode: "รหัสควบคุม",
                    connect: "เชื่อมต่อ",
                    startQuiz: "เริ่มเกม",
                    nextQuestion: "คำถามต่อไป",
                    showAnswer: "แสดงคำตอบ",
                    endGame: "จบเกม",
import: "นำเข้า",
export: "ส่งออก"
                },
                zh: {
                    welcomeTitle: "多语言问答游戏",
                    welcomeSubtitle: "用多种语言挑战你的知识",
                    hostMode: "成为主持人",
                    playerMode: "成为玩家",
                    remoteMode: "手机控制",
                    enterName: "请输入您的名字",
                    hostName: "主持人姓名",
                    confirm: "确认",
                    backHome: "返回首页",
                    joinGame: "加入游戏",
                    playerName: "玩家名称",
                    roomCode: "房间代码",
                    join: "加入",
                    questions: "问题",
                    addQuestion: "添加问题",
                    timePerQuestion: "每题时间 (秒)",
                    startGame: "开始游戏",
                    players: "玩家",
                    waitingForHost: "等待主持人开始游戏",
                    question: "问题",
                    timeLeft: "剩余时间",
                    leaderboard: "排行榜",
                    playerDetails: "玩家详情",
                    score: "分数",
                    finalResults: "最终结果",
                    backMain: "返回主菜单",
                    restartGame: "重新开始游戏",
                    copyCode: "复制代码",
                    tutorial: "教程",
                    remoteControl: "远程控制",
                    connected: "已连接",
                    disconnected: "连接断开",
                    controlCode: "控制代码",
                    connect: "连接",
                    startQuiz: "开始游戏",
                    nextQuestion: "下一题",
                    showAnswer: "显示答案",
                    endGame: "结束游戏"
                },
                ja: {
                    welcomeTitle: "多言語クイズゲーム",
                    welcomeSubtitle: "複数の言語で知識を試しましょう",
                    hostMode: "ホストになる",
                    playerMode: "プレイヤーになる",
                    remoteMode: "モバイルコントロール",
                    enterName: "名前を入力してください",
                    hostName: "ホスト名",
                    confirm: "確認",
                    backHome: "ホームに戻る",
                    joinGame: "ゲームに参加",
                    playerName: "プレイヤー名",
                    roomCode: "ルームコード",
                    join: "参加",
                    questions: "質問",
                    addQuestion: "質問を追加",
                    timePerQuestion: "質問ごとの時間 (秒)",
                    startGame: "ゲームを開始",
                    players: "プレイヤー",
                    waitingForHost: "ホストの開始を待っています",
                    question: "質問",
                    timeLeft: "残り時間",
                    leaderboard: "リーダーボード",
                    playerDetails: "プレイヤー詳細",
                    score: "スコア",
                    finalResults: "最終結果",
                    backMain: "メインに戻る",
                    restartGame: "ゲームを再開",
                    copyCode: "コードをコピー",
                    tutorial: "チュートリアル",
                    remoteControl: "リモートコントロール",
                    connected: "接続済み",
                    disconnected: "接続が切断されました",
                    controlCode: "制御コード",
                    connect: "接続",
                    startQuiz: "ゲーム開始",
                    nextQuestion: "次の質問",
                    showAnswer: "答えを表示",
                    endGame: "ゲーム終了"
                },
                ko: {
                    welcomeTitle: "다국어 퀴즈 게임",
                    welcomeSubtitle: "여러 언어로 지식을 테스트하세요",
                    hostMode: "호스트가 되기",
                    playerMode: "플레이어가 되기",
                    remoteMode: "모바일 제어",
                    enterName: "이름을 입력하세요",
                    hostName: "호스트 이름",
                    confirm: "확인",
                    backHome: "홈으로 돌아가기",
                    joinGame: "게임 참가",
                    playerName: "플레이어 이름",
                    roomCode: "방 코드",
                    join: "참가",
                    questions: "질문",
                    addQuestion: "질문 추가",
                    timePerQuestion: "질문당 시간 (초)",
                    startGame: "게임 시작",
                    players: "플레이어",
                    waitingForHost: "호스트가 게임을 시작할 때까지 기다리는 중",
                    question: "질문",
                    timeLeft: "남은 시간",
                    leaderboard: "리더보드",
                    playerDetails: "플레이어 세부 정보",
                    score: "점수",
                    finalResults: "최종 결과",
                    backMain: "메인으로 돌아가기",
                    restartGame: "게임 다시 시작",
                    copyCode: "코드 복사",
                    tutorial: "튜토리얼",
                    remoteControl: "리모컨",
                    connected: "연결됨",
                    disconnected: "연결 끊김",
                    controlCode: "제어 코드",
                    connect: "연결",
                    startQuiz: "게임 시작",
                    nextQuestion: "다음 질문",
                    showAnswer: "정답 보기",
                    endGame: "게임 종료"
                }
            }
        };

        // Utility Functions
        function t(key) {
            return appState.translations[appState.currentLanguage][key] || key;
        }

        function exportQuestions() {
            if (appState.quizData.questions.length === 0) {
                showAlert(t('error'), t('noQuestionsToExport'), 'error');
                return;
            }

            const data = {
                questions: appState.quizData.questions,
                timePerQuestion: appState.quizData.timePerQuestion
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportName = 'quiz_questions_' + new Date().toISOString().slice(0, 10) + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();
        }

        function importQuestions() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (!data.questions || !Array.isArray(data.questions)) {
                            throw new Error(t('invalidFileFormat'));
                        }
                        
                        // Validate question structure
                        const isValid = data.questions.every(q => 
                            q.text && 
                            q.options && 
                            Array.isArray(q.options) && 
                            q.options.length >= 2 && 
                            typeof q.correctOption === 'number'
                        );
                        
                        if (!isValid) {
                            throw new Error(t('invalidQuestionFormat'));
                        }
                        
                        // Import data
                        appState.quizData.questions = data.questions;
                        appState.quizData.timePerQuestion = data.timePerQuestion || 30;
                        
                        // Update UI
                        renderQuestions();
                        document.getElementById('timePerQuestion').value = appState.quizData.timePerQuestion;
                        
                        // Enable start button
                        updateStartButtonState();
                        
                        showAlert(t('success'), t('importSuccess'), 'success');
                    } catch (error) {
                        showAlert(t('error'), t('importFailed') + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function showAlert(title, text, icon, confirmButtonText = t('ok')) {
            return Swal.fire({
                title: title,
                text: text,
                icon: icon,
                confirmButtonText: confirmButtonText,
                customClass: {
                    confirmButton: 'btn btn-' + (icon === 'error' ? 'danger' : icon === 'warning' ? 'warning' : 'primary')
                },
                buttonsStyling: false
            });
        }

        function showConfirm(title, text, icon = 'warning') {
            return Swal.fire({
                title: title,
                text: text,
                icon: icon,
                showCancelButton: true,
                confirmButtonText: t('confirm'),
                cancelButtonText: t('cancel'),
                customClass: {
                    confirmButton: 'btn btn-primary me-2',
                    cancelButton: 'btn btn-secondary'
                },
                buttonsStyling: false
            });
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function createConfetti() {
            confetti({
                particleCount: 200,
                spread: 80,
                origin: { y: 0.6 },
                colors: ['#6c5ce7', '#00b894', '#fdcb6e', '#d63031', '#0984e3']
            });
        }

        function generateShortPeerId() {
            const timestampPart = Date.now().toString().slice(-6);
            const randomPart = Math.floor(10 + Math.random() * 90).toString();
            return timestampPart + randomPart;
        }

        async function createUniquePeerId() {
            return generateShortPeerId();
        }

        // Language Functions
        function changeLanguage(lang) {
            appState.currentLanguage = lang;
            document.getElementById('currentLanguage').textContent = lang.toUpperCase();
            
            // Update active language in selector
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-lang') === lang) {
                    option.classList.add('active');
                }
            });
            
            // Re-render current screen
            if (appState.role === 'host') {
                renderHostScreen();
            } else if (appState.role === 'player') {
                if (appState.quizData.questions.length > 0) {
                    renderQuizScreen();
                } else {
                    renderWaitingScreen();
                }
            } else {
                renderHomeScreen();
            }
        }

        function setupLanguageSelector() {
            document.getElementById('currentLanguage').addEventListener('click', function() {
                const options = document.getElementById('languageOptions');
                options.style.display = options.style.display === 'block' ? 'none' : 'block';
            });
            
            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', function() {
                    const lang = this.getAttribute('data-lang');
                    changeLanguage(lang);
                    document.getElementById('languageOptions').style.display = 'none';
                });
            });
            
            // Close language selector when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.language-selector')) {
                    document.getElementById('languageOptions').style.display = 'none';
                }
            });
        }

        // Core Game Functions
        function initApp() {
            setupLanguageSelector();
            renderHomeScreen();
        }

        function renderHomeScreen() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="animate__animated animate__fadeIn">
                    <div class="welcome-container">
                        <h1 class="welcome-title">${t('welcomeTitle')}</h1>
                        <p class="welcome-subtitle">${t('welcomeSubtitle')}</p>
                        
                        <div class="row justify-content-center mt-4">
                            <div class="col-md-4 mb-4">
                                <div class="mode-card">
                                    <div class="card-body text-center py-5">
                                        <div class="mode-icon">
                                            <i class="fas fa-user-shield"></i>
                                        </div>
                                        <h4>${t('hostMode')}</h4>
                                        <p class="text-muted">${t('hostModeDesc')}</p>
                                        <button class="btn btn-primary mt-3" onclick="selectHostMode()">
                                            ${t('hostMode')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-4">
                                <div class="mode-card">
                                    <div class="card-body text-center py-5">
                                        <div class="mode-icon">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <h4>${t('playerMode')}</h4>
                                        <p class="text-muted">${t('playerModeDesc')}</p>
                                        <button class="btn btn-success mt-3" onclick="renderPlayerScreen()">
                                            ${t('playerMode')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-4">
                                <div class="mode-card">
                                    <div class="card-body text-center py-5">
                                        <div class="mode-icon">
                                            <i class="fas fa-mobile-alt"></i>
                                        </div>
                                        <h4>${t('remoteMode')}</h4>
                                        <p class="text-muted">${t('remoteModeDesc')}</p>
                                        <button class="btn btn-info mt-3" onclick="renderRemoteControlScreen()">
                                            ${t('remoteMode')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('helpButton').style.display = 'none';
        }

        function selectHostMode() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="animate__animated animate__fadeIn">
                    <h1 class="text-center mb-4">${t('hostMode')}</h1>
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header text-center">
                                    <h4 class="mb-0">${t('enterName')}</h4>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="hostName" class="form-label">${t('hostName')}</label>
                                        <input type="text" class="form-control" id="hostName" placeholder="${t('enterName')}">
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="renderHostScreen()">
                                            <i class="fas fa-check me-1"></i> ${t('confirm')}
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="renderHomeScreen()">
                                            <i class="fas fa-arrow-left me-1"></i> ${t('backHome')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPlayerScreen() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="animate__animated animate__fadeIn">
                    <h1 class="text-center mb-4">${t('joinGame')}</h1>
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header text-center">
                                    <h4 class="mb-0">${t('joinGame')}</h4>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="playerName" class="form-label">${t('playerName')}</label>
                                        <input type="text" class="form-control" id="playerName" placeholder="${t('playerName')}">
                                    </div>
                                    <div class="mb-3">
                                        <label for="roomId" class="form-label">${t('roomCode')}</label>
                                        <input type="text" class="form-control" id="roomId" placeholder="${t('roomCode')}">
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="joinRoom()">
                                            <i class="fas fa-sign-in-alt me-1"></i> ${t('join')}
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="renderHomeScreen()">
                                            <i class="fas fa-arrow-left me-1"></i> ${t('backHome')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('helpButton').style.display = 'none';
        }

        function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomId = document.getElementById('roomId').value.trim();
            
            if (!playerName || !roomId) {
                showAlert(t('error'), t('enterNameAndCode'), 'error');
                return;
            }
            
            appState.playerName = playerName;
            appState.role = 'player';
            
            Swal.fire({
                title: t('connecting'),
                html: t('pleaseWait'),
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            
            initializePeer(false, roomId);
        }

        async function renderHostScreen() {
            const hostName = document.getElementById('hostName')?.value.trim() || "Quiz Master";
            appState.playerName = hostName;
            appState.role = 'host';
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="host-container animate__animated animate__fadeIn">
                    <div class="host-header text-center mb-4">
                        <h2>${t('roomCode')}: <span id="hostId" class="fw-bold room-id"></span></h2>
                        <div class="d-flex justify-content-center gap-2 mt-3">
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyHostId()">
                                <i class="fas fa-copy me-1"></i> ${t('copyCode')}
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="showTutorial()">
                                <i class="fas fa-question-circle me-1"></i> ${t('tutorial')}
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="showRemoteControlInfo()">
                                <i class="fas fa-mobile-alt me-1"></i> ${t('remoteControl')}
                            </button>
                        </div>
                        ${appState.remoteControl.isControlled ? `
                        <div class="mt-3">
                            <span class="badge bg-success">
                                <i class="fas fa-mobile-alt me-1"></i> ${t('remoteControlled')}
                            </span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">${t('questions')}</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="importQuestions()">
                                            <i class="fas fa-file-import me-1"></i> ${t('import')}
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="exportQuestions()">
                                            <i class="fas fa-file-export me-1"></i> ${t('export')}
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="addQuestion()">
                                            <i class="fas fa-plus me-1"></i> ${t('addQuestion')}
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" id="questionsContainer">
                                    <!-- Questions will be added here -->
                                </div>
                                <div class="card-footer">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="w-50">
                                            <label class="form-label">${t('timePerQuestion')}</label>
                                            <input type="number" class="form-control" id="timePerQuestion" 
                                                min="5" max="120" value="${appState.quizData.timePerQuestion}">
                                        </div>
                                        <button class="btn btn-success" id="startQuizButton" onclick="startQuiz()">
                                            <i class="fas fa-play me-1"></i> ${t('startGame')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">${t('players')} (${Object.keys(appState.players).length})</h5>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="updatePlayersList()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <div class="card-body" id="playersList" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Players will be listed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            await initializePeer(true);
            renderQuestions();
            updateStartButtonState();
        }

        function updateStartButtonState() {
            const startButton = document.getElementById('startQuizButton');
            if (!startButton) return;
            
            if (appState.quizData.questions.length === 0) {
                startButton.disabled = true;
                startButton.classList.add('btn-secondary');
                startButton.classList.remove('btn-success');
                startButton.title = t('addQuestionsFirst');
            } else {
                startButton.disabled = false;
                startButton.classList.remove('btn-secondary');
                startButton.classList.add('btn-success');
                startButton.title = '';
            }
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (appState.quizData.questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-question-circle fa-3x mb-3"></i>
                        <p>${t('noQuestions')}</p>
                    </div>
                `;
                return;
            }
            
            appState.quizData.questions.forEach((question, index) => {
                const questionElement = document.createElement('div');
                questionElement.className = 'question-card mb-3';
                questionElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">${t('question')} ${index + 1}</h6>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeQuestion(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">${t('question')}</label>
                        <input type="text" class="form-control question-text" value="${question.text}" 
                            onchange="updateQuestion(${index}, 'text', this.value)">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">${t('options')}</label>
                        ${question.options.map((option, optIndex) => `
                            <div class="input-group mb-2">
                                <input type="text" class="form-control option-text" value="${option.text}" 
                                    onchange="updateQuestionOption(${index}, ${optIndex}, this.value)">
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0" type="radio" name="correctOption${index}" 
                                        value="${optIndex}" ${optIndex === question.correctOption ? 'checked' : ''}
                                        onchange="updateQuestionCorrectOption(${index}, ${optIndex})">
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(questionElement);
            });
        }

        function addQuestion() {
            appState.quizData.questions.push({
                text: t('newQuestion'),
                options: [
                    { text: t('option') + ' 1' },
                    { text: t('option') + ' 2' },
                    { text: t('option') + ' 3' },
                    { text: t('option') + ' 4' }
                ],
                correctOption: 0
            });
            
            renderQuestions();
            updateStartButtonState();
        }

        function removeQuestion(index) {
            appState.quizData.questions.splice(index, 1);
            renderQuestions();
            updateStartButtonState();
        }

        function updateQuestion(index, field, value) {
            appState.quizData.questions[index][field] = value;
        }

        function updateQuestionOption(questionIndex, optionIndex, value) {
            appState.quizData.questions[questionIndex].options[optionIndex].text = value;
        }

        function updateQuestionCorrectOption(questionIndex, optionIndex) {
            appState.quizData.questions[questionIndex].correctOption = optionIndex;
        }

        function startQuiz() {
            if (appState.quizData.questions.length === 0) {
                showAlert(t('error'), t('addQuestionsFirst'), 'error');
                return;
            }
            
            appState.quizData.timePerQuestion = parseInt(document.getElementById('timePerQuestion').value) || 30;
            appState.quizData.currentQuestion = 0;
            appState.quizData.showAnswer = false;
            
            // Reset players' scores
            Object.keys(appState.players).forEach(playerId => {
                appState.players[playerId].score = 0;
                appState.players[playerId].answer = null;
                appState.players[playerId].answerTime = null;
            });
            
            // Broadcast game start to all players
            broadcastToAllPlayers({
                type: 'gameStart',
                data: appState.quizData
            });
            
            // Start the first question
            nextQuestion();
        }

        function nextQuestion() {
            if (appState.quizData.currentQuestion >= appState.quizData.questions.length) {
                endQuiz();
                return;
            }
            
            appState.quizData.showAnswer = false;
            appState.timeLeft = appState.quizData.timePerQuestion;
            
            // Reset players' answers for this question
            Object.keys(appState.players).forEach(playerId => {
                appState.players[playerId].answer = null;
                appState.players[playerId].answerTime = null;
            });
            
            // Broadcast question to all players
            broadcastToAllPlayers({
                type: 'newQuestion',
                questionIndex: appState.quizData.currentQuestion,
                question: appState.quizData.questions[appState.quizData.currentQuestion],
                timeLeft: appState.timeLeft
            });
            
            // Start timer
            if (appState.timer) {
                clearInterval(appState.timer);
            }
            
            appState.timer = setInterval(() => {
                appState.timeLeft--;
                
                // Update time for all players
                broadcastToAllPlayers({
                    type: 'timeUpdate',
                    timeLeft: appState.timeLeft
                });
                
                if (appState.timeLeft <= 0) {
                    clearInterval(appState.timer);
                    showAnswer();
                }
            }, 1000);
            
            // Update host UI
            if (appState.role === 'host') {
                renderQuestionForHost();
            }
        }

        function showAnswer() {
            appState.quizData.showAnswer = true;
            clearInterval(appState.timer);
            
            // Calculate scores
            const currentQuestion = appState.quizData.questions[appState.quizData.currentQuestion];
            Object.keys(appState.players).forEach(playerId => {
                const player = appState.players[playerId];
                
                if (player.answer === currentQuestion.correctOption) {
                    // Correct answer
                    const timeBonus = Math.floor((appState.timeLeft / appState.quizData.timePerQuestion) * 100);
                    player.score += 100 + timeBonus;
                    
                    // Send correct answer notification to player
                    sendToPlayer(playerId, {
                        type: 'answerResult',
                        isCorrect: true,
                        score: 100 + timeBonus
                    });
                } else if (player.answer !== null) {
                    // Incorrect answer
                    sendToPlayer(playerId, {
                        type: 'answerResult',
                        isCorrect: false,
                        correctAnswer: currentQuestion.correctOption
                    });
                }
            });
            
            // Broadcast answer to all players
            broadcastToAllPlayers({
                type: 'showAnswer',
                correctAnswer: currentQuestion.correctOption,
                leaderboard: getSortedPlayers()
            });
            
            // Update host UI
            if (appState.role === 'host') {
                renderQuestionForHost(true);
                updatePlayersList();
            }
            
            // Move to next question
            appState.quizData.currentQuestion++;
        }

        function endQuiz() {
            clearInterval(appState.timer);
            
            // Broadcast game end to all players
            broadcastToAllPlayers({
                type: 'gameEnd',
                leaderboard: getSortedPlayers()
            });
            
            // Show final leaderboard on host
            if (appState.role === 'host') {
                showLeaderboardFullscreen(true);
            }
        }

        function renderQuestionForHost(showAnswer = false) {
            if (appState.role !== 'host') return;
            
            const currentQuestion = appState.quizData.questions[appState.quizData.currentQuestion];
            const app = document.getElementById('app');
            
            const questionSection = app.querySelector('.host-container .row > .col-md-8');
            if (!questionSection) return;
            
            questionSection.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${t('question')} ${appState.quizData.currentQuestion + 1}/${appState.quizData.questions.length}</h5>
                        <span class="badge bg-primary">${t('timeLeft')}: ${appState.timeLeft} ${t('seconds')}</span>
                    </div>
                    <div class="card-body">
                        <h4 class="mb-4">${currentQuestion.text}</h4>
                        
                        <div class="answer-chart-container">
                            <canvas id="answerChart"></canvas>
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            ${showAnswer ? `
                                <button class="btn btn-warning" onclick="nextQuestion()">
                                    <i class="fas fa-arrow-right me-1"></i> ${t('nextQuestion')}
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="showAnswer()">
                                    <i class="fas fa-lightbulb me-1"></i> ${t('showAnswer')}
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize answer chart
            renderAnswerChart(showAnswer ? currentQuestion.correctOption : null);
        }

        function renderAnswerChart(correctAnswer = null) {
            const ctx = document.getElementById('answerChart').getContext('2d');
            
            // Count answers for each option
            const answerCounts = [0, 0, 0, 0];
            Object.values(appState.players).forEach(player => {
                if (player.answer !== null) {
                    answerCounts[player.answer]++;
                }
            });
            
            // Destroy previous chart if exists
            if (appState.answerChart) {
                appState.answerChart.destroy();
            }
            
            // Create new chart
            appState.answerChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [
                        t('option') + ' 1', 
                        t('option') + ' 2', 
                        t('option') + ' 3', 
                        t('option') + ' 4'
                    ],
                    datasets: [{
                        label: t('playersAnswered'),
                        data: answerCounts,
                        backgroundColor: answerCounts.map((count, index) => 
                            correctAnswer !== null ? 
                                (index === correctAnswer ? 'rgba(0, 184, 148, 0.7)' : 'rgba(214, 48, 49, 0.7)') : 
                                'rgba(108, 92, 231, 0.7)'
                        ),
                        borderColor: answerCounts.map((count, index) => 
                            correctAnswer !== null ? 
                                (index === correctAnswer ? 'rgba(0, 184, 148, 1)' : 'rgba(214, 48, 49, 1)') : 
                                'rgba(108, 92, 231, 1)'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: correctAnswer !== null ? 
                                t('correctAnswerIs') + ' ' + t('option') + ' ' + (correctAnswer + 1) : 
                                t('answerStatistics'),
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }

        function updatePlayersList() {
            const playersList = document.getElementById('playersList');
            if (!playersList) return;
            
            playersList.innerHTML = '';
            
            if (Object.keys(appState.players).length === 0) {
                playersList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <p>${t('noPlayers')}</p>
                    </div>
                `;
                return;
            }
            
            const sortedPlayers = getSortedPlayers();
            
            sortedPlayers.forEach((player, index) => {
                const playerElement = document.createElement('div');
                playerElement.className = 'leaderboard-item';
                playerElement.innerHTML = `
                    <div class="leaderboard-position">
                        ${index + 1}
                    </div>
                    <div class="leaderboard-name">
                        ${player.name}
                    </div>
                    <div class="leaderboard-score">
                        ${player.score}
                    </div>
                    <button class="btn btn-sm btn-outline-info" onclick="showPlayerDetails('${player.id}')">
                        <i class="fas fa-info-circle"></i>
                    </button>
                `;
                
                // Highlight top 3 players
                if (index === 0) {
                    playerElement.querySelector('.leaderboard-position').innerHTML = `
                        <i class="fas fa-trophy medal-gold"></i>
                    `;
                } else if (index === 1) {
                    playerElement.querySelector('.leaderboard-position').innerHTML = `
                        <i class="fas fa-trophy medal-silver"></i>
                    `;
                } else if (index === 2) {
                    playerElement.querySelector('.leaderboard-position').innerHTML = `
                        <i class="fas fa-trophy medal-bronze"></i>
                    `;
                }
                
                playersList.appendChild(playerElement);
            });
        }

        function getSortedPlayers() {
            return Object.keys(appState.players)
                .map(playerId => ({
                    id: playerId,
                    name: appState.players[playerId].name,
                    score: appState.players[playerId].score || 0,
                    answer: appState.players[playerId].answer,
                    answerTime: appState.players[playerId].answerTime
                }))
                .sort((a, b) => b.score - a.score);
        }

        function showPlayerDetails(playerId) {
            const player = appState.players[playerId];
            if (!player) return;
            
            const detailsContent = document.getElementById('playerDetailsContent');
            detailsContent.innerHTML = `
                <div class="mb-3">
                    <h5>${player.name}</h5>
                    <p>${t('score')}: <strong>${player.score || 0}</strong></p>
                </div>
                
                <div class="mb-3">
                    <h6>${t('answerHistory')}</h6>
                    <div class="history-chart-container">
                        <canvas id="historyChart"></canvas>
                    </div>
                </div>
            `;
            
            // Set modal title
            document.getElementById('playerDetailsTitle').textContent = t('playerDetails');
            
            // Initialize history chart
            renderPlayerHistoryChart(playerId);
            
            // Show modal
            document.getElementById('playerDetails').style.display = 'flex';
        }

        function hidePlayerDetails() {
            document.getElementById('playerDetails').style.display = 'none';
            
            // Destroy chart
            if (appState.historyChart) {
                appState.historyChart.destroy();
                appState.historyChart = null;
            }
        }

        function renderPlayerHistoryChart(playerId) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            const player = appState.players[playerId];
            
            // Prepare data for chart
            const labels = appState.quizData.questions.map((q, i) => `${t('question')} ${i + 1}`);
            const correctAnswers = appState.quizData.questions.map(q => q.correctOption);
            const playerAnswers = player.answers || [];
            
            // Destroy previous chart if exists
            if (appState.historyChart) {
                appState.historyChart.destroy();
            }
            
            // Create new chart
            appState.historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: t('correctAnswers'),
                            data: correctAnswers,
                            borderColor: 'rgba(0, 184, 148, 1)',
                            backgroundColor: 'rgba(0, 184, 148, 0.1)',
                            borderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: false
                        },
                        {
                            label: t('playerAnswers'),
                            data: playerAnswers,
                            borderColor: 'rgba(108, 92, 231, 1)',
                            backgroundColor: 'rgba(108, 92, 231, 0.1)',
                            borderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return `${t('option')} ${value + 1}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function showLeaderboardFullscreen(isFinal = false) {
            const sortedPlayers = getSortedPlayers();
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="fullscreen-leaderboard animate__animated animate__fadeIn">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>${isFinal ? t('finalResults') : t('leaderboard')}</h2>
                        <button class="btn btn-outline-secondary" onclick="${isFinal ? 'renderHostScreen()' : 'renderQuestionForHost(true)'}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="leaderboard-container w-100" style="max-width: 600px;">
                        ${sortedPlayers.map((player, index) => `
                            <div class="leaderboard-item ${player.id === appState.peer.id ? 'me' : ''}">
                                <div class="leaderboard-position">
                                    ${index === 0 ? '<i class="fas fa-trophy medal-gold"></i>' : 
                                      index === 1 ? '<i class="fas fa-trophy medal-silver"></i>' : 
                                      index === 2 ? '<i class="fas fa-trophy medal-bronze"></i>' : index + 1}
                                </div>
                                <div class="leaderboard-name">
                                    ${player.name}
                                </div>
                                <div class="leaderboard-score">
                                    ${player.score}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${isFinal ? `
                    <div class="d-grid gap-2 mt-4" style="max-width: 300px;">
                        <button class="btn btn-primary" onclick="restartQuiz()">
                            <i class="fas fa-redo me-1"></i> ${t('restartGame')}
                        </button>
                        <button class="btn btn-outline-secondary" onclick="renderHostScreen()">
                            <i class="fas fa-home me-1"></i> ${t('backMain')}
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
            
            if (isFinal) {
                createConfetti();
            }
        }

        function refreshLeaderboard() {
            broadcastLeaderboardUpdate();
        }

        function broadcastLeaderboardUpdate() {
            const now = Date.now();
            if (now - appState.lastLeaderboardUpdate < 1000) return; // Throttle updates
            
            appState.lastLeaderboardUpdate = now;
            
            broadcastToAllPlayers({
                type: 'leaderboardUpdate',
                leaderboard: getSortedPlayers()
            });
        }

        function copyHostId() {
            const hostId = document.getElementById('hostId').textContent;
            navigator.clipboard.writeText(hostId).then(() => {
                showAlert(t('success'), t('codeCopied'), 'success');
            }).catch(err => {
                showAlert(t('error'), t('copyFailed') + err, 'error');
            });
        }

        function restartQuiz() {
            appState.quizData.currentQuestion = 0;
            startQuiz();
        }

        // PeerJS Functions
        async function initializePeer(isHost, hostId = null) {
            try {
                const peerId = await createUniquePeerId();
                
                appState.peer = new Peer(peerId, {
                    debug: 2,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:global.stun.twilio.com:3478' }
                        ]
                    }
                });

                appState.peer.on('open', (id) => {
                    if (isHost) {
                        document.getElementById('hostId').textContent = id;
                        Swal.close();
                    } else {
                        // Connect to host
                        const conn = appState.peer.connect(hostId);
                        appState.hostConnection = conn;
                        
                        conn.on('open', () => {
                            Swal.close();
                            
                            // Send player info to host
                            conn.send({
                                type: 'playerJoin',
                                name: appState.playerName
                            });
                            
                            // Render waiting screen
                            renderWaitingScreen();
                        });
                        
                        conn.on('data', (data) => {
                            handleDataFromHost(data);
                        });
                        
                        conn.on('close', () => {
                            showAlert(t('notice'), t('connectionClosed'), 'info');
                            renderHomeScreen();
                        });
                        
                        conn.on('error', (err) => {
                            Swal.close();
                            showAlert(t('error'), t('connectionFailed') + err.message, 'error');
                            renderHomeScreen();
                        });
                    }
                });
                
                appState.peer.on('connection', (conn) => {
                    conn.on('open', () => {
                        // Regular player connection
                        appState.connections[conn.peer] = conn;
                        addPlayer(conn.peer);
                        
                        if (appState.quizData.questions.length > 0) {
                            sendToPlayer(conn.peer, {
                                type: 'gameData',
                                data: appState.quizData,
                                leaderboard: getSortedPlayers()
                            });
                        }
                    });
                    
                    conn.on('data', (data) => {
                        handleData(conn.peer, data);
                    });
                    
                    conn.on('close', () => {
                        if (isHost) {
                            removePlayer(conn.peer);
                            delete appState.connections[conn.peer];
                            updatePlayersList();
                            broadcastLeaderboardUpdate();
                        }
                    });
                });
                
                appState.peer.on('error', (err) => {
                    Swal.close();
                    showAlert(t('error'), t('connectionError') + err.message, 'error');
                    renderHomeScreen();
                });

            } catch (error) {
                Swal.close();
                showAlert(t('error'), t('initializationError') + error.message, 'error');
                renderHomeScreen();
            }
        }

        function addPlayer(playerId, name = t('newPlayer')) {
            if (!appState.players[playerId]) {
                appState.players[playerId] = {
                    name: name,
                    score: 0,
                    answers: [],
                    answer: null,
                    answerTime: null
                };
                
                updatePlayersList();
            }
        }

        function removePlayer(playerId) {
            delete appState.players[playerId];
            updatePlayersList();
        }

        function handleData(playerId, data) {
            switch (data.type) {
                case 'playerJoin':
                    addPlayer(playerId, data.name);
                    break;
                    
                case 'playerAnswer':
                    if (appState.players[playerId]) {
                        appState.players[playerId].answer = data.answer;
                        appState.players[playerId].answerTime = data.answerTime;
                        
                        // Track answer history
                        if (!appState.players[playerId].answers) {
                            appState.players[playerId].answers = [];
                        }
                        appState.players[playerId].answers[appState.quizData.currentQuestion] = data.answer;
                        
                        // Update answer chart if host
                        if (appState.role === 'host') {
                            renderAnswerChart();
                        }
                    }
                    break;
            }
        }

        function handleDataFromHost(data) {
            switch (data.type) {
                case 'gameStart':
                    appState.quizData = data.data;
                    renderQuizScreen();
                    break;
                    
                case 'newQuestion':
                    appState.quizData.currentQuestion = data.questionIndex;
                    renderQuestion(data.question, data.timeLeft);
                    break;
                    
                case 'timeUpdate':
                    updateTimer(data.timeLeft);
                    break;
                    
                case 'showAnswer':
                    showQuestionAnswer(data.correctAnswer, data.leaderboard);
                    break;
                    
                case 'gameEnd':
                    showFinalResults(data.leaderboard);
                    break;
                    
                case 'leaderboardUpdate':
                    updateLeaderboard(data.leaderboard);
                    break;
                    
                case 'gameData':
                    appState.quizData = data.data;
                    updateLeaderboard(data.leaderboard);
                    break;
            }
        }

        function broadcastToAllPlayers(data) {
            Object.keys(appState.connections).forEach(playerId => {
                sendToPlayer(playerId, data);
            });
        }

        function sendToPlayer(playerId, data) {
            if (appState.connections[playerId] && appState.connections[playerId].open) {
                appState.connections[playerId].send(data);
            }
        }

        // Player Functions
        function renderWaitingScreen() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="animate__animated animate__fadeIn">
                    <div class="card">
                        <div class="card-header text-center">
                            <h4 class="mb-0">${t('waitingForHost')}</h4>
                        </div>
                        <div class="card-body text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>${t('waitingForHostDesc')}</p>
                            <div id="leaderboardPreview"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('helpButton').style.display = 'none';
        }

        function renderQuizScreen() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="animate__animated animate__fadeIn">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">${t('question')} ${appState.quizData.currentQuestion + 1}/${appState.quizData.questions.length}</h5>
                            <span class="badge bg-primary" id="timeBadge">${appState.timeLeft} ${t('seconds')}</span>
                        </div>
                        <div class="card-body">
                            <div class="timer-container mb-4">
                                <div class="timer-bar" id="timerBar"></div>
                            </div>
                            
                            <h4 class="mb-4" id="questionText"></h4>
                            
                            <div class="options-container" id="optionsContainer"></div>
                            
                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <div id="answerStatus"></div>
                                <button class="btn btn-outline-primary" onclick="showLeaderboardFullscreen()">
                                    <i class="fas fa-list-ol me-1"></i> ${t('leaderboard')}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('helpButton').style.display = 'flex';
            
            // Start with first question
            renderQuestion(
                appState.quizData.questions[appState.quizData.currentQuestion],
                appState.quizData.timePerQuestion
            );
        }

        function renderQuestion(question, timeLeft) {
            appState.timeLeft = timeLeft;
            appState.answerSubmitted = false;
            appState.helpUsed = false;
            
            document.getElementById('questionText').textContent = question.text;
            document.getElementById('timeBadge').textContent = `${timeLeft} ${t('seconds')}`;
            document.getElementById('timerBar').style.width = '100%';
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'option-btn btn btn-outline-primary question-animate';
                optionBtn.style.animationDelay = `${index * 0.1}s`;
                optionBtn.textContent = option.text;
                optionBtn.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(optionBtn);
            });
            
            document.getElementById('answerStatus').innerHTML = '';
            
            // Start timer
            if (appState.timer) {
                clearInterval(appState.timer);
            }
            
            appState.timer = setInterval(() => {
                appState.timeLeft--;
                document.getElementById('timeBadge').textContent = `${appState.timeLeft} ${t('seconds')}`;
                document.getElementById('timerBar').style.width = `${(appState.timeLeft / appState.quizData.timePerQuestion) * 100}%`;
                
                if (appState.timeLeft <= 0) {
                    clearInterval(appState.timer);
                    if (!appState.answerSubmitted) {
                        document.getElementById('answerStatus').innerHTML = `
                            <div class="text-danger">
                                <i class="fas fa-times-circle me-1"></i> ${t('timeUp')}
                            </div>
                        `;
                    }
                }
            }, 1000);
        }

        function selectAnswer(answerIndex) {
            if (appState.answerSubmitted) return;
            
            appState.answerSubmitted = true;
            clearInterval(appState.timer);
            
            // Send answer to host
            appState.hostConnection.send({
                type: 'playerAnswer',
                answer: answerIndex,
                answerTime: Date.now()
            });
            
            // Highlight selected answer
            const optionBtns = document.querySelectorAll('.option-btn');
            optionBtns.forEach((btn, index) => {
                btn.classList.remove('selected');
                if (index === answerIndex) {
                    btn.classList.add('selected');
                }
            });
            
            document.getElementById('answerStatus').innerHTML = `
                <div class="text-success">
                    <i class="fas fa-check-circle me-1"></i> ${t('answered')}
                </div>
            `;
        }

        function showQuestionAnswer(correctAnswer, leaderboard) {
            clearInterval(appState.timer);
            
            const optionBtns = document.querySelectorAll('.option-btn');
            optionBtns.forEach((btn, index) => {
                btn.disabled = true;
                if (index === correctAnswer) {
                    btn.classList.add('correct');
                } else if (btn.classList.contains('selected') && index !== correctAnswer) {
                    btn.classList.add('incorrect');
                }
            });
            
            updateLeaderboard(leaderboard);
        }

        function showFinalResults(leaderboard) {
            clearInterval(appState.timer);
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="fullscreen-leaderboard animate__animated animate__fadeIn">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>${t('finalResults')}</h2>
                        <button class="btn btn-outline-secondary" onclick="renderHomeScreen()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="leaderboard-container w-100" style="max-width: 600px;">
                        ${leaderboard.map((player, index) => `
                            <div class="leaderboard-item ${player.id === appState.peer.id ? 'me' : ''}">
                                <div class="leaderboard-position">
                                    ${index === 0 ? '<i class="fas fa-trophy medal-gold"></i>' : 
                                      index === 1 ? '<i class="fas fa-trophy medal-silver"></i>' : 
                                      index === 2 ? '<i class="fas fa-trophy medal-bronze"></i>' : index + 1}
                                </div>
                                <div class="leaderboard-name">
                                    ${player.name}
                                </div>
                                <div class="leaderboard-score">
                                    ${player.score}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="d-grid gap-2 mt-4" style="max-width: 300px;">
                        <button class="btn btn-primary" onclick="renderHomeScreen()">
                            <i class="fas fa-home me-1"></i> ${t('backMain')}
                        </button>
                    </div>
                </div>
            `;
            
            createConfetti();
            document.getElementById('helpButton').style.display = 'none';
        }

        function updateLeaderboard(leaderboard) {
            const leaderboardPreview = document.getElementById('leaderboardPreview');
            if (!leaderboardPreview) return;
            
            leaderboardPreview.innerHTML = `
                <h6 class="mt-3 mb-2">${t('currentRanking')}</h6>
                ${leaderboard.slice(0, 5).map((player, index) => `
                    <div class="d-flex justify-content-between align-items-center mb-2 ${player.id === appState.peer.id ? 'fw-bold' : ''}">
                        <span>
                            ${index === 0 ? '<i class="fas fa-crown medal-gold me-1"></i>' : 
                              index === 1 ? '<i class="fas fa-crown medal-silver me-1"></i>' : 
                              index === 2 ? '<i class="fas fa-crown medal-bronze me-1"></i>' : ''}
                            ${player.name}
                        </span>
                        <span class="badge bg-primary rounded-pill">${player.score}</span>
                    </div>
                `).join('')}
            `;
        }

        function updateTimer(timeLeft) {
            appState.timeLeft = timeLeft;
            if (document.getElementById('timeBadge')) {
                document.getElementById('timeBadge').textContent = `${timeLeft} ${t('seconds')}`;
                document.getElementById('timerBar').style.width = `${(timeLeft / appState.quizData.timePerQuestion) * 100}%`;
            }
        }

        function useHelp() {
            if (appState.helpUsed || appState.answerSubmitted) return;
            
            appState.helpUsed = true;
            
            // Remove two incorrect options
            const currentQuestion = appState.quizData.questions[appState.quizData.currentQuestion];
            const optionBtns = document.querySelectorAll('.option-btn');
            let removedCount = 0;
            
            optionBtns.forEach((btn, index) => {
                if (removedCount < 2 && index !== currentQuestion.correctOption && !btn.disabled) {
                    btn.disabled = true;
                    btn.classList.add('d-none');
                    removedCount++;
                }
            });
            
            // Disable help button
            document.getElementById('helpButton').classList.remove('animate__pulse');
            document.getElementById('helpButton').style.opacity = '0.5';
        }

        // Initialize the app
        window.onload = initApp;

        // Global functions
        window.renderHostScreen = renderHostScreen;
        window.renderPlayerScreen = renderPlayerScreen;
        window.joinRoom = joinRoom;
        window.addQuestion = addQuestion;
        window.removeQuestion = removeQuestion;
        window.startQuiz = startQuiz;
        window.nextQuestion = nextQuestion;
        window.showAnswer = showAnswer;
        window.copyHostId = copyHostId;
        window.showPlayerDetails = showPlayerDetails;
        window.hidePlayerDetails = hidePlayerDetails;
        window.refreshLeaderboard = refreshLeaderboard;
        window.showLeaderboardFullscreen = showLeaderboardFullscreen;
        window.importQuestions = importQuestions;
        window.exportQuestions = exportQuestions;
        window.useHelp = useHelp;
        window.selectHostMode = selectHostMode;
        window.renderRemoteControlScreen = renderRemoteControlScreen;
        window.verifyControlCode = verifyControlCode;
        window.sendControlCommand = sendControlCommand;
        window.disconnectRemoteControl = disconnectRemoteControl;
        window.copyControlCode = copyControlCode;
        window.restartQuiz = restartQuiz;
        window.showTutorial = showTutorial;
    </script>
</body>
</html>